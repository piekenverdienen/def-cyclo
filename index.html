<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Indoor Cycling Schema</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-b from-purple-800 to-black">
  <div id="root"></div>
  <script type="text/babel">
    const {useState} = React;

    function TrainingIntake({ onComplete }) {
      const [level, setLevel] = useState('beginner');
      const [days, setDays] = useState(3);
      const [ftp, setFtp] = useState('');
      const [hours, setHours] = useState('');
      const [email, setEmail] = useState('');

      const handleSubmit = (e) => {
        e.preventDefault();
        const parsedFtp = parseInt(ftp);
        const parsedHours = parseFloat(hours);
        if (!email) {
          alert('E-mailadres is verplicht');
          return;
        }
        onComplete({
          level,
          days: Number(days),
          hours: isNaN(parsedHours) ? 5 : parsedHours,
          ftp: isNaN(parsedFtp) ? 200 : parsedFtp,
          email,
        });
      };

      return (
        <div className="min-h-screen flex items-center justify-center text-white">
          <form onSubmit={handleSubmit} className="bg-white bg-opacity-90 text-gray-800 p-8 rounded-lg w-full max-w-md space-y-4">
            <h1 className="text-3xl font-bold text-center text-purple-800">Gratis 6 Weken Trainingsschema</h1>
            <p className="text-center text-sm text-gray-700">Vul je niveau, beschikbare tijd en FTP in. Na verzending krijg je direct een persoonlijk schema.</p>

            <div>
              <label className="block mb-1">Niveau:</label>
              <select value={level} onChange={(e) => setLevel(e.target.value)} className="w-full border border-gray-300 p-2 rounded">
                <option value="beginner">Beginner</option>
                <option value="intermediate">Gevorderd</option>
                <option value="advanced">Expert</option>
              </select>
            </div>

            <div>
              <label className="block mb-1">Dagen per week:</label>
              <input type="number" value={days} onChange={(e) => setDays(e.target.value)} className="w-full border border-gray-300 p-2 rounded" min="1" max="7" />
            </div>

            <div>
              <label className="block mb-1">Uren beschikbaar per week:</label>
              <input type="number" value={hours} onChange={(e) => setHours(e.target.value)} className="w-full border border-gray-300 p-2 rounded" min="1" step="0.5" />
            </div>

            <div>
              <label className="block mb-1">FTP:</label>
              <input type="number" value={ftp} onChange={(e) => setFtp(e.target.value)} className="w-full border border-gray-300 p-2 rounded" />
            </div>

            <div>
              <label className="block mb-1">E-mailadres:</label>
              <input type="email" required value={email} onChange={(e) => setEmail(e.target.value)} className="w-full border border-gray-300 p-2 rounded" />
            </div>

            <button type="submit" className="w-full bg-purple-700 text-white py-2 rounded hover:bg-purple-800">Genereer Schema</button>
          </form>
        </div>
      );
    }

    function totalMinutes(blocks) {
      return blocks.reduce((sum, b) => {
        if (b.type === 'interval') {
          return sum + b.repeats * (b.minutes + b.rest);
        }
        return sum + b.minutes;
      }, 0);
    }

    function scaleBlocks(blocks, target) {
      const ratio = target / totalMinutes(blocks);
      return blocks.map((b) => {
        const scaled = {...b};
        scaled.minutes = Math.round(b.minutes * ratio);
        if (b.rest) scaled.rest = Math.round(b.rest * ratio);
        return scaled;
      });
    }

    function computeTss(blocks) {
      let tss = 0;
      blocks.forEach((b) => {
        if (b.type === 'interval') {
          for (let i = 0; i < b.repeats; i++) {
            tss += (b.minutes / 60) * Math.pow(b.factor, 2) * 100;
            tss += (b.rest / 60) * Math.pow(b.restFactor, 2) * 100;
          }
        } else {
          tss += (b.minutes / 60) * Math.pow(b.factor, 2) * 100;
        }
      });
      return Math.round(tss);
    }

    const templates = {
      beginner: {
        endurance: [
          { type: 'warmup', minutes: 10, factor: 0.55 },
          { type: 'endurance', minutes: 40, factor: 0.65 },
          { type: 'cooldown', minutes: 5, factor: 0.5 },
        ],
        interval: [
          { type: 'warmup', minutes: 10, factor: 0.55 },
          { type: 'interval', minutes: 4, factor: 1.05, repeats: 5, rest: 3, restFactor: 0.55 },
          { type: 'cooldown', minutes: 5, factor: 0.5 },
        ],
        vo2max: [
          { type: 'warmup', minutes: 10, factor: 0.55 },
          { type: 'interval', minutes: 3, factor: 1.2, repeats: 5, rest: 3, restFactor: 0.55 },
          { type: 'cooldown', minutes: 5, factor: 0.5 },
        ],
        steigerung: [
          { type: 'warmup', minutes: 10, factor: 0.55 },
          { type: 'interval', minutes: 6, factor: 0.7, repeats: 1, rest: 0, restFactor: 0.55 },
          { type: 'endurance', minutes: 20, factor: 0.75 },
          { type: 'cooldown', minutes: 5, factor: 0.5 },
        ],
        tempo: [
          { type: 'warmup', minutes: 10, factor: 0.55 },
          { type: 'endurance', minutes: 20, factor: 0.8 },
          { type: 'endurance', minutes: 15, factor: 0.85 },
          { type: 'cooldown', minutes: 5, factor: 0.5 },
        ],
      },
      intermediate: {
        endurance: [
          { type: 'warmup', minutes: 10, factor: 0.6 },
          { type: 'endurance', minutes: 50, factor: 0.7 },
          { type: 'cooldown', minutes: 5, factor: 0.5 },
        ],
        interval: [
          { type: 'warmup', minutes: 10, factor: 0.6 },
          { type: 'interval', minutes: 5, factor: 1.05, repeats: 6, rest: 3, restFactor: 0.6 },
          { type: 'cooldown', minutes: 5, factor: 0.5 },
        ],
        vo2max: [
          { type: 'warmup', minutes: 10, factor: 0.6 },
          { type: 'interval', minutes: 4, factor: 1.2, repeats: 6, rest: 3, restFactor: 0.6 },
          { type: 'cooldown', minutes: 5, factor: 0.5 },
        ],
        steigerung: [
          { type: 'warmup', minutes: 10, factor: 0.6 },
          { type: 'interval', minutes: 8, factor: 0.75, repeats: 1, rest: 0, restFactor: 0.6 },
          { type: 'endurance', minutes: 30, factor: 0.8 },
          { type: 'cooldown', minutes: 5, factor: 0.5 },
        ],
        tempo: [
          { type: 'warmup', minutes: 10, factor: 0.6 },
          { type: 'endurance', minutes: 25, factor: 0.85 },
          { type: 'endurance', minutes: 20, factor: 0.9 },
          { type: 'cooldown', minutes: 5, factor: 0.5 },
        ],
      },
      advanced: {
        endurance: [
          { type: 'warmup', minutes: 10, factor: 0.65 },
          { type: 'endurance', minutes: 60, factor: 0.75 },
          { type: 'cooldown', minutes: 5, factor: 0.5 },
        ],
        interval: [
          { type: 'warmup', minutes: 10, factor: 0.65 },
          { type: 'interval', minutes: 6, factor: 1.1, repeats: 6, rest: 3, restFactor: 0.6 },
          { type: 'cooldown', minutes: 5, factor: 0.5 },
        ],
        vo2max: [
          { type: 'warmup', minutes: 10, factor: 0.65 },
          { type: 'interval', minutes: 5, factor: 1.25, repeats: 6, rest: 3, restFactor: 0.6 },
          { type: 'cooldown', minutes: 5, factor: 0.5 },
        ],
        steigerung: [
          { type: 'warmup', minutes: 10, factor: 0.65 },
          { type: 'interval', minutes: 10, factor: 0.8, repeats: 1, rest: 0, restFactor: 0.6 },
          { type: 'endurance', minutes: 40, factor: 0.85 },
          { type: 'cooldown', minutes: 5, factor: 0.5 },
        ],
        tempo: [
          { type: 'warmup', minutes: 10, factor: 0.65 },
          { type: 'endurance', minutes: 30, factor: 0.9 },
          { type: 'endurance', minutes: 25, factor: 0.95 },
          { type: 'cooldown', minutes: 5, factor: 0.5 },
        ],
      },
    };

    function generateSchema({ level, days, ftp, hours }) {
      const sessionMinutes = Math.round((hours * 60) / days);
      const hiSessions = Math.max(1, Math.round(days * 0.2));
      const hiTypes = ['interval', 'vo2max', 'steigerung', 'tempo'];
      let hiIndex = 0;

      const schema = [];
      for (let week = 1; week <= 6; week++) {
        let weeklyTss = 0;
        for (let d = 1; d <= days; d++) {
          const highIntensity = d <= hiSessions;
          const type = highIntensity ? hiTypes[hiIndex++ % hiTypes.length] : 'endurance';
          const base = templates[level][type];
          const blocks = scaleBlocks(base, sessionMinutes);
          const tss = computeTss(blocks);
          weeklyTss += tss;
          schema.push({
            week,
            day: d,
            title: type.charAt(0).toUpperCase() + type.slice(1),
            blocks,
            tss,
          });
        }
        schema.push({ summary: true, week, weeklyTss: Math.round(weeklyTss) });
      }
      return schema;
    }

    function generateTcxWorkout(title, blocks, ftp) {
      const steps = [];
      blocks.forEach((b) => {
        if (b.type === 'interval') {
          for (let i=0;i<b.repeats;i++) {
            steps.push({ name:`Interval ${i+1}`, duration:b.minutes*60, power:Math.round(ftp*b.factor) });
            if (b.rest) {
              steps.push({ name:`Rust ${i+1}`, duration:b.rest*60, power:Math.round(ftp*b.restFactor) });
            }
          }
        } else {
          steps.push({ name: b.type, duration: b.minutes*60, power: Math.round(ftp*b.factor) });
        }
      });
      const xmlSteps = steps.map((s) => `\n      <Step>\n        <Name>${s.name}</Name>\n        <Duration>\n          <DurationType>Time</DurationType>\n          <Seconds>${s.duration}</Seconds>\n        </Duration>\n        <Target>\n          <TargetType>Power</TargetType>\n          <PowerZone>${s.power}</PowerZone>\n        </Target>\n      </Step>`).join('');
      return `<?xml version="1.0" encoding="UTF-8"?>\n<TrainingCenterDatabase xmlns="http://www.garmin.com/xmlschemas/TrainingCenterDatabase/v2">\n  <Workouts>\n    <Workout Sport="Biking">\n      <Name>${title}</Name>${xmlSteps}\n    </Workout>\n  </Workouts>\n</TrainingCenterDatabase>`;
    }

    function downloadTcx(title, blocks, ftp) {
      const xml = generateTcxWorkout(title, blocks, ftp);
      const blob = new Blob([xml], { type: 'application/xml' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${title.replace(/\s+/g, '_')}.tcx`;
      link.click();
    }

    function generateGpxWorkout(title, blocks, ftp) {
      const steps = [];
      blocks.forEach((b) => {
        if (b.type === 'interval') {
          for (let i=0;i<b.repeats;i++) {
            steps.push({name:`Interval ${i+1}`, power:Math.round(ftp*b.factor), duration:b.minutes*60});
            if(b.rest){ steps.push({name:`Rust ${i+1}`, power:Math.round(ftp*b.restFactor), duration:b.rest*60}); }
          }
        } else {
          steps.push({name:b.type, power:Math.round(ftp*b.factor), duration:b.minutes*60});
        }
      });
      const points = steps.map((s,i) => `<trkpt lat="0" lon="0"><extensions><power>${s.power}</power><duration>${s.duration}</duration><name>${s.name}</name></extensions></trkpt>`).join('');
      return `<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="def-cyclo">\n  <metadata><name>${title}</name></metadata>\n  <trk><name>${title}</name><trkseg>${points}</trkseg></trk>\n</gpx>`;
    }

    function downloadGpx(title, blocks, ftp) {
      const xml = generateGpxWorkout(title, blocks, ftp);
      const blob = new Blob([xml], { type: 'application/gpx+xml' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${title.replace(/\s+/g, '_')}.gpx`;
      link.click();
    }

    function SchemaView({ intake, onUpdateFtp }) {
      const schema = generateSchema(intake);
      return (
        <div className="min-h-screen bg-gray-100 p-6">
          <div className="max-w-3xl mx-auto bg-white shadow rounded-lg p-6 space-y-6">
            <h1 className="text-3xl font-bold text-gray-800">Trainingsschema</h1>
            <p className="text-gray-600">Niveau: <strong>{intake.level}</strong> · Dagen/week: <strong>{intake.days}</strong> · Uren/week: <strong>{intake.hours}</strong> · FTP: <strong>{intake.ftp} watt</strong></p>
            <div className="grid gap-4">
              {schema.map((item, index) => item.summary ? (
                <div key={index} className="border-t pt-2">
                  <p className="font-semibold text-right">Week {item.week} TSS: {item.weeklyTss}</p>
                </div>
              ) : (
                <div key={index} className="bg-purple-50 p-4 rounded shadow-sm border border-purple-200">
                  <h2 className="text-xl font-semibold text-purple-800">Week {item.week} - Dag {item.day}</h2>
                  <p className="text-gray-700 mb-2">Trainingsvorm: <strong>{item.title}</strong> · TSS: {item.tss}</p>
                  <ul className="list-disc ml-5 text-gray-600">
                    {item.blocks.map((b, i) => (
                      <li key={i}>
                        {b.type === 'interval' ? `${b.repeats}x ${b.minutes} min @ ${Math.round(intake.ftp * b.factor)} watt` + (b.rest ? ` + ${b.rest} min rust @ ${Math.round(intake.ftp * b.restFactor)} watt` : '') : `${b.minutes} min @ ${Math.round(intake.ftp * b.factor)} watt (${b.type})`}
                      </li>
                    ))}
                  </ul>
                  <div className="mt-3 space-x-2">
                    <button onClick={() => downloadTcx(item.title, item.blocks, intake.ftp)} className="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">Download .TCX</button>
                    <button onClick={() => downloadGpx(item.title, item.blocks, intake.ftp)} className="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Download .GPX</button>
                  </div>
                </div>
              ))}
            </div>
            <div className="pt-4">
              <label className="block text-gray-700 font-medium mb-1">Update je FTP:</label>
              <input type="number" className="w-full border border-gray-300 p-2 rounded" placeholder="Nieuwe FTP" onChange={(e) => onUpdateFtp(parseInt(e.target.value))} />
            </div>
          </div>
        </div>
      );
    }

    function App() {
      const [intake, setIntake] = useState(null);
      const handleUpdateFtp = (newFtp) => setIntake(prev => ({ ...prev, ftp: newFtp }));
      return intake ? <SchemaView intake={intake} onUpdateFtp={handleUpdateFtp} /> : <TrainingIntake onComplete={setIntake} />;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
