<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wielren Schema App</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  </head>
  <body class="bg-gradient-to-b from-purple-800 to-black min-h-screen text-white">
    <div id="root" class="p-6"></div>

    <script type="text/babel">
      const { useState } = React;

      function totalMinutes(blocks) {
        return blocks.reduce((sum, b) => {
          if (b.type === 'interval') {
            return sum + b.repeats * (b.minutes + b.rest);
          }
          return sum + b.minutes;
        }, 0);
      }

      function scaleBlocks(blocks, target) {
        const ratio = target / totalMinutes(blocks);
        return blocks.map(b => {
          const res = { ...b };
          res.minutes = Math.round(b.minutes * ratio);
          if (b.rest) res.rest = Math.round(b.rest * ratio);
          return res;
        });
      }

      function computeTss(blocks, ftp) {
        let tss = 0;
        blocks.forEach(b => {
          if (b.type === 'interval') {
            for (let i = 0; i < b.repeats; i++) {
              tss += (b.minutes/60) * Math.pow(b.factor,2) * 100;
              tss += (b.rest/60) * Math.pow(b.restFactor,2) * 100;
            }
          } else {
            tss += (b.minutes/60) * Math.pow(b.factor,2) * 100;
          }
        });
        return Math.round(tss);
      }

      const templates = {
        endurance: [
          { type:'warmup', minutes:10, factor:0.55 },
          { type:'endurance', minutes:40, factor:0.65 },
          { type:'cooldown', minutes:5, factor:0.5 }
        ],
        interval: [
          { type:'warmup', minutes:10, factor:0.55 },
          { type:'interval', minutes:4, repeats:5, factor:1.05, rest:3, restFactor:0.55 },
          { type:'cooldown', minutes:5, factor:0.5 }
        ],
        tempo: [
          { type:'warmup', minutes:10, factor:0.55 },
          { type:'tempo', minutes:20, factor:0.9 },
          { type:'cooldown', minutes:5, factor:0.5 }
        ],
        steigerung: [
          { type:'warmup', minutes:10, factor:0.55 },
          { type:'steigerung', minutes:15, factor:1.0 },
          { type:'cooldown', minutes:5, factor:0.5 }
        ],
        vo2max: [
          { type:'warmup', minutes:10, factor:0.55 },
          { type:'interval', minutes:3, repeats:6, factor:1.15, rest:3, restFactor:0.55 },
          { type:'cooldown', minutes:5, factor:0.5 }
        ]
      };

      function generateSchedule({ level, days, ftp, hours }) {
        const sessionMins = Math.round((hours * 60) / days);
        const hiSessions = Math.max(1, Math.round(days * 0.2));
        const hiTypes = ['interval', 'vo2max', 'steigerung', 'tempo'];
        const schedule = [];
        let hiIndex = 0;

        for (let week=1; week<=6; week++) {
          let weekTss = 0;
          const workouts = [];
          for (let d=1; d<=days; d++) {
            const highIntensity = d <= hiSessions;
            const type = highIntensity ? hiTypes[(hiIndex++) % hiTypes.length] : 'endurance';
            const blocks = scaleBlocks(templates[type], sessionMins);
            const tss = computeTss(blocks, ftp);
            weekTss += tss;
            workouts.push({ day:`Week ${week} - Dag ${d}`, type, blocks, tss });
          }
          schedule.push({ week, workouts, tss: weekTss });
        }
        return schedule;
      }

      function generateFit(workout, ftp) {
        let lines = [`Title:${workout.day}`];
        workout.blocks.forEach(b => {
          if (b.type === 'interval') {
            for(let i=0;i<b.repeats;i++){
              lines.push(`${b.type},${b.minutes}min,${Math.round(ftp*b.factor)}`);
              lines.push(`rest,${b.rest}min,${Math.round(ftp*b.restFactor)}`);
            }
          } else {
            lines.push(`${b.type},${b.minutes}min,${Math.round(ftp*b.factor)}`);
          }
        });
        return new Blob([lines.join('\n')], {type:'application/octet-stream'});
      }

      function TrainingIntake({ onComplete }) {
        const [step, setStep] = useState(1);
        const [email, setEmail] = useState('');
        const [level, setLevel] = useState('beginner');
        const [days, setDays] = useState(3);
        const [ftp, setFtp] = useState('');
        const [hours, setHours] = useState('');

        const submitEmail = e => {
          e.preventDefault();
          if (!email) { alert('E-mailadres is verplicht'); return; }
          setStep(2);
        };

        const submitDetails = e => {
          e.preventDefault();
          const parsedFtp = parseInt(ftp);
          const parsedHours = parseFloat(hours);
          onComplete({
            email,
            level,
            days,
            ftp: isNaN(parsedFtp)?220:parsedFtp,
            hours: isNaN(parsedHours)?5:parsedHours,
          });
        };

        return (
          <div className="min-h-screen flex items-center justify-center">
            {step===1 && (
              <form onSubmit={submitEmail} className="bg-white text-gray-800 p-8 rounded shadow-md w-full max-w-md space-y-4">
                <h1 className="text-3xl font-bold text-center text-purple-700">Gratis 6 Weken Trainingsschema</h1>
                <p className="text-center text-gray-600">Laat je e-mailadres achter om direct toegang te krijgen.</p>
                <input type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="E-mailadres" className="w-full border p-2 rounded" required />
                <button className="w-full bg-purple-700 text-white py-2 rounded" type="submit">Volgende</button>
              </form>
            )}
            {step===2 && (
              <form onSubmit={submitDetails} className="bg-white text-gray-800 p-8 rounded shadow-md w-full max-w-md space-y-4">
                <div>
                  <label className="block mb-1">Niveau</label>
                  <select value={level} onChange={e=>setLevel(e.target.value)} className="w-full border p-2 rounded">
                    <option value="beginner">Beginner</option>
                    <option value="intermediate">Gevorderd</option>
                    <option value="advanced">Expert</option>
                  </select>
                </div>
                <div>
                  <label className="block mb-1">Dagen per week</label>
                  <input type="number" min="1" max="7" value={days} onChange={e=>setDays(parseInt(e.target.value))} className="w-full border p-2 rounded" />
                </div>
                <div>
                  <label className="block mb-1">FTP</label>
                  <input type="number" value={ftp} onChange={e=>setFtp(e.target.value)} className="w-full border p-2 rounded" />
                </div>
                <div>
                  <label className="block mb-1">Uren per week beschikbaar</label>
                  <input type="number" min="1" step="0.5" value={hours} onChange={e=>setHours(e.target.value)} className="w-full border p-2 rounded" />
                </div>
                <button className="w-full bg-purple-700 text-white py-2 rounded" type="submit">Schema genereren</button>
              </form>
            )}
          </div>
        );
      }

      function SchemaView({ intake }) {
        const schedule = generateSchedule(intake);

        return (
          <div className="max-w-3xl mx-auto space-y-6">
            {schedule.map(week => (
              <div key={week.week} className="bg-white text-gray-800 p-6 rounded shadow-md">
                <h2 className="text-xl font-bold mb-2">Week {week.week} - Totale TSS: {week.tss}</h2>
                <ul className="space-y-4">
                  {week.workouts.map((w,idx)=> (
                    <li key={idx} className="border border-purple-200 rounded p-4">
                      <h3 className="font-semibold">{w.day} â€“ {w.type}</h3>
                      <ul className="list-disc ml-6 text-sm">
                        {w.blocks.map((b,i)=> (
                          <li key={i}>{b.type==='interval' ? `${b.repeats}x${b.minutes}m @ ${Math.round(intake.ftp*b.factor)}w + ${b.rest}m rust` : `${b.minutes}m ${b.type}`}</li>
                        ))}
                      </ul>
                      <p className="mt-2 text-sm">TSS: {w.tss}</p>
                      <button onClick={() => {
                        const blob = generateFit(w, intake.ftp);
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = `${w.day.replace(/\s+/g,'_')}.fit`;
                        a.click();
                      }} className="mt-2 inline-block bg-purple-700 text-white px-3 py-1 rounded">Download .FIT</button>
                    </li>
                  ))}
                </ul>
              </div>
            ))}
          </div>
        );
      }

      function App() {
        const [intake, setIntake] = useState(null);
        return intake ? <SchemaView intake={intake} /> : <TrainingIntake onComplete={setIntake} />;
      }

      ReactDOM.render(<App />, document.getElementById('root'));
    </script>
  </body>
</html>
